import { useEffect, useMemo, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Mail,
  Phone,
  MapPin,
  MoreHorizontal,
  Filter,
  Download,
  RefreshCw,
  Settings,
  Plus,
  Star,
} from "lucide-react";
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { API_BASE } from "@/lib/api/base";

interface Company {
  name: string;
  rating: number;
  email: string;
  phone: string;
  location: string;
  avatar?: string;
  labels?: string[];
}

const SAMPLE: Company[] = [
  {
    name: "NovaWave LLC",
    rating: 4.2,
    email: "robertson@example.com",
    phone: "+1 8754555453",
    location: "Germany",
    labels: ["Collab", "Rated"],
  },
  {
    name: "BlueSky Industries",
    rating: 5.0,
    email: "sharon@example.com",
    phone: "+1 989757485",
    location: "USA",
    labels: ["Collab", "Rated"],
  },
  {
    name: "Summit Peak",
    rating: 4.5,
    email: "jessica13@gmail.com",
    phone: "+1 89316-83167",
    location: "India",
    labels: ["Collab", "Rated"],
  },
  {
    name: "RiverStone Venture",
    rating: 4.7,
    email: "river@stone.com",
    phone: "+1 5551112222",
    location: "USA",
    labels: ["Collab"],
  },
  {
    name: "Bright Bridge Grp",
    rating: 5.0,
    email: "bridge@bright.co",
    phone: "+1 5553334444",
    location: "UK",
    labels: ["Rated"],
  },
];


export default function Companies() {
  const [query, setQuery] = useState("");
  const [filter, setFilter] = useState("All");
  const [items, setItems] = useState<Company[]>(SAMPLE);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        setLoading(true);
        const res = await fetch(`${API_BASE}/api/companies`);
        if (!res.ok) throw new Error("Failed to load");
        const data: Company[] = await res.json();
        if (mounted && Array.isArray(data) && data.length) setItems(data);
      } catch (e) {
        // fallback to SAMPLE
      } finally {
        setLoading(false);
      }
    })();
    return () => { mounted = false; };
  }, []);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    return items.filter((c) =>
      [c.name, c.email, c.phone, c.location].some((v) => v.toLowerCase().includes(q))
    );
  }, [query, items]);

  return (
    <div className="space-y-4 animate-fade-in">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <h1 className="text-xl font-semibold">Companies</h1>
          <span className="text-xs px-2 py-0.5 rounded-full bg-muted">{filtered.length}</span>
        </div>
        <div className="flex items-center gap-2">
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline" size="sm" className="gap-2">Export <Download className="w-4 h-4"/></Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem>CSV</DropdownMenuItem>
              <DropdownMenuItem>Excel</DropdownMenuItem>
              <DropdownMenuItem>PDF</DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
          <Button variant="outline" size="icon" aria-label="refresh"><RefreshCw className="w-4 h-4"/></Button>
          <Button variant="outline" size="icon" aria-label="settings"><Settings className="w-4 h-4"/></Button>
          {/* Add Company */}
          <AddCompanyDialog onCreated={(c)=> setItems((prev)=>[c as Company, ...prev])} />
        </div>
      </div>

      {/* Toolbar */}
      <Card>
        <CardContent className="p-4 flex items-center gap-2 flex-wrap">
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline" className="gap-2"><Filter className="w-4 h-4"/> Filter</Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="start">
              <DropdownMenuItem onClick={() => setFilter("All")}>All</DropdownMenuItem>
              <DropdownMenuItem onClick={() => setFilter("Collab")}>Collab</DropdownMenuItem>
              <DropdownMenuItem onClick={() => setFilter("Rated")}>Rated</DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
          <div className="relative">
            <Input placeholder="Search" value={query} onChange={(e)=>setQuery(e.target.value)} className="w-72" />
          </div>
        </CardContent>
      </Card>

      {/* Grid */}
      <div className="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
        {filtered
          .filter((c) => filter === "All" || (c.labels || []).includes(filter))
          .map((c, idx) => (
          <Card key={idx} className="border bg-card">
            <CardContent className="p-4">
              <div className="flex items-start justify-between">
                <div className="flex items-start gap-3">
                  <Avatar className="h-12 w-12">
                    <AvatarImage src={c.avatar} alt={c.name} />
                    <AvatarFallback>{c.name.split(" ").map((s) => s[0]).join("")}</AvatarFallback>
                  </Avatar>
                  <div>
                    <div className="font-semibold">{c.name}</div>
                    <div className="flex items-center gap-1 text-sm text-amber-600">
                      <Star className="w-4 h-4 fill-amber-400 text-amber-400"/> {c.rating.toFixed(1)}
                    </div>
                  </div>
                </div>
                <Button variant="ghost" size="icon"><MoreHorizontal className="w-4 h-4"/></Button>
              </div>

              <div className="mt-3 space-y-1.5 text-sm">
                <div className="flex items-center gap-2 text-muted-foreground"><Mail className="w-4 h-4"/> {c.email}</div>
                <div className="flex items-center gap-2 text-muted-foreground"><Phone className="w-4 h-4"/> {c.phone}</div>
                <div className="flex items-center gap-2 text-muted-foreground"><MapPin className="w-4 h-4"/> {c.location}</div>
              </div>

              {c.labels && c.labels.length > 0 && (
                <div className="mt-3 flex items-center gap-2 flex-wrap">
                  {c.labels.map((l) => (
                    <Badge key={l} variant="outline" className={l === "Rated" ? "bg-amber-100 text-amber-800 border-amber-200" : "bg-emerald-100 text-emerald-800 border-emerald-200"}>
                      {l}
                    </Badge>
                  ))}
                </div>
              )}

              <div className="mt-4 flex items-center justify-between text-muted-foreground">
                <div className="flex items-center gap-4 text-sm">
                  <span className="hover:text-foreground cursor-pointer">‚úâÔ∏è</span>
                  <span className="hover:text-foreground cursor-pointer">üìû</span>
                  <span className="hover:text-foreground cursor-pointer">üóìÔ∏è</span>
                  <span className="hover:text-foreground cursor-pointer">üîó</span>
                </div>
                <Avatar className="h-6 w-6">
                  <AvatarImage src="" />
                  <AvatarFallback>AG</AvatarFallback>
                </Avatar>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}

function AddCompanyDialog({ onCreated }: { onCreated: (c: Partial<Company>) => void }) {
  const [category, setCategory] = useState("-");
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [notes, setNotes] = useState("");
  return (
    <Dialog>
      <DialogTrigger asChild>
        <Button size="sm" className="gap-2"><Plus className="w-4 h-4"/> Add Company</Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-3xl">
        <DialogHeader>
          <DialogTitle>Add company</DialogTitle>
        </DialogHeader>
        <div className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
            <Label className="md:text-right text-muted-foreground">Name</Label>
            <Input placeholder="Company name" value={name} onChange={(e)=>setName(e.target.value)} className="md:col-span-4" />
          </div>
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
            <Label className="md:text-right text-muted-foreground">Email</Label>
            <Input placeholder="contact@company.com" value={email} onChange={(e)=>setEmail(e.target.value)} className="md:col-span-4" />
          </div>
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
            <Label className="md:text-right text-muted-foreground">Phone</Label>
            <Input placeholder="+1 0000000000" value={phone} onChange={(e)=>setPhone(e.target.value)} className="md:col-span-4" />
          </div>
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
            <Label className="md:text-right text-muted-foreground">Category</Label>
            <Select value={category} onValueChange={setCategory}>
              <SelectTrigger className="md:col-span-4"><SelectValue placeholder="-"/></SelectTrigger>
              <SelectContent>
                <SelectItem value="-">-</SelectItem>
                <SelectItem value="partner">Partner</SelectItem>
                <SelectItem value="client">Client</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-start">
            <Label className="md:text-right text-muted-foreground">Notes</Label>
            <Textarea placeholder="Notes" value={notes} onChange={(e)=>setNotes(e.target.value)} className="md:col-span-4 min-h-[120px]" />
          </div>
        </div>
        <DialogFooter className="gap-2">
          <Button variant="outline">Close</Button>
          <Button onClick={async ()=>{
            const payload: Partial<Company> = { name, email, phone } as any;
            try {
              const res = await fetch(`${API_BASE}/api/companies`, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
              if (res.ok) {
                const created = await res.json();
                onCreated(created);
              }
            } catch {}
          }}>Save</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
